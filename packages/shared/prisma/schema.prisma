// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. Ролі користувачів (Enum)
enum Role {
  ADMIN
  MANAGER
  MECHANIC
  CLIENT
}

// 3. Статуси замовлення (Enum)
enum OrderStatus {
  NEW // Нове (заявка)
  IN_PROGRESS // В роботі (механік робить)
  WAITING_PARTS // Очікує запчастин
  COMPLETED // Виконано (чекає оплати/видачі)
  PAID // Оплачено і закрито
  CANCELLED // Скасовано
}

model User {
  id       Int    @id @default(autoincrement())
  email    String @unique
  password String

  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  phone     String?
  roles     Role[]  @default([CLIENT])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Зв'язки
  cars           Car[] // Автомобілі клієнта
  managerOrders  Order[] @relation("ManagerOrders") // Замовлення, які вів менеджер
  mechanicOrders Order[] @relation("MechanicOrders") // Замовлення, які виконував механік

  @@map("users")
}

// 5. Автомобілі
model Car {
  id          Int     @id @default(autoincrement())
  vin         String  @unique // VIN-код унікальний
  brand       String // Марка (BMW)
  model       String // Модель (X5)
  year        Int // Рік випуску
  plateNumber String? @map("plate_number") // Держ. номер

  ownerId Int  @map("owner_id")
  owner   User @relation(fields: [ownerId], references: [id])

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("cars")
}

// 6. Склад запчастин (Inventory)
model Part {
  id           Int     @id @default(autoincrement())
  name         String // Назва (Фільтр масляний)
  sku          String  @unique // Артикул виробника
  manufacturer String? // Виробник (Bosch, Mann)

  quantity Int @default(0) // Залишок на складі

  buyPrice  Decimal @map("buy_price") @db.Decimal(10, 2) // Ціна закупівлі
  sellPrice Decimal @map("sell_price") @db.Decimal(10, 2) // Ціна продажу клієнту

  location String? // Місце на складі (Полиця А-1)

  orderParts OrderPart[] // Зв'язок з використанням у замовленнях

  @@map("parts")
}

// 7. Довідник послуг (Services Catalog)
model Service {
  id            Int     @id @default(autoincrement())
  name          String // Назва роботи (Заміна мастила)
  pricePerHour  Decimal @map("price_per_hour") @db.Decimal(10, 2) // Ціна нормо-години
  estimatedTime Float   @default(1.0) @map("estimated_time") // Орієнтовний час (годин)

  orderServices OrderService[]

  @@map("services")
}

// 8. Замовлення (Order / Repair Ticket)
model Order {
  id     Int         @id @default(autoincrement())
  status OrderStatus @default(NEW)

  description String? @db.Text // Скарги клієнта / опис проблеми
  mileage     Int // Пробіг на момент заїзду

  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(10, 2) // Загальна сума

  // Зв'язки з людьми
  carId Int @map("car_id")
  car   Car @relation(fields: [carId], references: [id])

  managerId Int?  @map("manager_id") // Хто прийняв
  manager   User? @relation("ManagerOrders", fields: [managerId], references: [id])

  mechanicId Int?  @map("mechanic_id") // Хто робить
  mechanic   User? @relation("MechanicOrders", fields: [mechanicId], references: [id])

  // Деталі замовлення (що конкретно робили і які запчастини ставили)
  parts    OrderPart[]
  services OrderService[]

  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")

  @@map("orders")
}

// 9. Проміжна таблиця: Запчастини в замовленні
model OrderPart {
  id Int @id @default(autoincrement())

  orderId Int   @map("order_id")
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  partId Int  @map("part_id")
  part   Part @relation(fields: [partId], references: [id])

  quantity Int @default(1) // Скільки штук використали

  // Важливо: зберігаємо ціну на момент замовлення (історія цін)
  price Decimal @db.Decimal(10, 2)

  @@map("order_parts")
}

// 10. Проміжна таблиця: Послуги (роботи) в замовленні
model OrderService {
  id Int @id @default(autoincrement())

  orderId Int   @map("order_id")
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  serviceId Int     @map("service_id")
  service   Service @relation(fields: [serviceId], references: [id])

  quantity Float @default(1) // Кількість нормо-годин або кількість операцій

  // Важливо: ціна на момент виконання
  price Decimal @db.Decimal(10, 2)

  @@map("order_services")
}

// 11. Для AI RAG (Технічна документація)
model Document {
  id       Int    @id @default(autoincrement())
  filename String // Назва файлу (Manual_Golf_5.pdf)
  content  String @db.Text // Текст, витягнутий з PDF

  // Вектори зберігаються окремо або через розширення pgvector. 
  // Для диплома часто достатньо зберігати текст і шукати по ньому, 
  // або використовувати Pinecone, тоді тут зберігаємо тільки метадані.
  externalId String? @map("external_id") // ID вектора в Pinecone

  createdAt DateTime @default(now()) @map("created_at")

  @@map("documents")
}
