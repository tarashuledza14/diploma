// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  MECHANIC
}

enum OrderStatus {
  NEW // Нове (заявка)
  IN_PROGRESS // В роботі (механік робить)
  WAITING_PARTS // Очікує запчастин
  COMPLETED // Виконано (чекає оплати/видачі)
  PAID // Оплачено і закрито
  CANCELLED // Скасовано
}

enum OrderPriority {
  LOW
  MEDIUM
  HIGH
}

enum VehicleStatus {
  OUT // У клієнта (не на території СТО) - це дефолтний статус
  PENDING // Приїхала, стоїть на парковці/прийманні (очікує майстра)
  IN_SERVICE // Знаходиться в боксі (на підйомнику, в роботі)
  TEST_DRIVE // На тест-драйві (перевірка майстром)
  READY // Готова, стоїть на парковці видачі (чекає клієнта)
}

// 1. Таблиця ТІЛЬКИ для персоналу (Admin, Manager, Mechanic)
model User {
  id       String @id @default(cuid())
  email    String @unique
  password String // Обов'язкове поле!
  role     Role   @default(MECHANIC) // Ролі тільки персоналу

  fullName String
  avatar   String?

  deletedAt DateTime?

  // Зв'язки співробітника
  managerOrders  Order[] @relation("ManagerOrders")
  mechanicOrders Order[] @relation("MechanicOrders")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// 2. Таблиця ТІЛЬКИ для клієнтів (без паролів)
model Client {
  id       String  @id @default(cuid())
  fullName String
  phone    String  @unique // Для СТО телефон важливіший за email
  email    String? // Email може бути необов'язковим

  notes String? // Нотатки про клієнта ("Любить каву", "Проблемний")

  // Денормалізовані поля для швидкого сортування
  totalSpent   Decimal   @default(0) @map("total_spent") // Загальна сума всіх замовлень
  totalOrders  Int       @default(0) @map("total_orders") // Кількість замовлень
  vehicleCount Int       @default(0) @map("vehicle_count") // Кількість автомобілів
  latestVisit  DateTime? @map("latest_visit") // Дата останнього замовлення

  // Зв'язки клієнта
  vehicles Vehicle[]
  orders   Order[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([totalSpent])
  @@index([totalOrders])
  @@index([vehicleCount])
  @@index([latestVisit])
  @@map("clients")
}

// 5. Автомобілі
model Vehicle {
  id          String  @id @default(cuid())
  vin         String  @unique // VIN-код унікальний
  brand       String // Марка (BMW)
  model       String // Модель (X5)
  year        Int // Рік випуску
  plateNumber String? @map("plate_number") // Держ. номер
  mileage     Int
  ownerId     String  @map("owner_id")
  owner       Client  @relation(fields: [ownerId], references: [id])

  lastService DateTime? @map("last_service_date")

  color         String?
  status        VehicleStatus @default(OUT)
  totalServices Int           @default(0) @map("total_services")
  orders        Order[]
  deletedAt     DateTime?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("vehicles")
}

// 6. Склад запчастин (Inventory)
model Part {
  id           String  @id @default(cuid())
  name         String // Назва (Фільтр масляний)
  sku          String  @unique // Артикул виробника
  manufacturer String? // Виробник (Bosch, Mann)

  quantity Int @default(0) // Залишок на складі

  buyPrice  Decimal @map("buy_price") @db.Decimal(10, 2) // Ціна закупівлі
  sellPrice Decimal @map("sell_price") @db.Decimal(10, 2) // Ціна продажу клієнту

  location String? // Місце на складі (Полиця А-1)

  orderParts OrderPart[] // Зв'язок з використанням у замовленнях

  @@map("parts")
}

// 7. Довідник послуг (Services Catalog)
model Service {
  id            String  @id @default(cuid())
  name          String // Назва роботи (Заміна мастила)
  pricePerHour  Decimal @map("price_per_hour") @db.Decimal(10, 2) // Ціна нормо-години
  estimatedTime Float   @default(1.0) @map("estimated_time") // Орієнтовний час (годин)

  orderServices OrderService[]

  @@map("services")
}

// 8. Замовлення (Order / Repair Ticket)
model Order {
  id     String      @id @default(cuid())
  status OrderStatus @default(NEW)

  description String? @db.Text // Скарги клієнта / опис проблеми

  totalAmount Decimal       @default(0) @map("total_amount") @db.Decimal(10, 2) // Загальна сума
  priority    OrderPriority @default(MEDIUM)

  // Зв'язки з людьми
  vehicleId String    @map("vehicle_id")
  vehicle   Vehicle   @relation(fields: [vehicleId], references: [id])
  deletedAt DateTime?

  // Хто прийняв замовлення? (Менеджер - User)
  managerId String? @map("manager_id")
  manager   User?   @relation("ManagerOrders", fields: [managerId], references: [id])

  // Хто робить ремонт? (Механік - User)
  mechanicId String? @map("mechanic_id")
  mechanic   User?   @relation("MechanicOrders", fields: [mechanicId], references: [id])

  // Хто клієнт? (Обов'язково)
  clientId String @map("client_id")
  client   Client @relation(fields: [clientId], references: [id])

  // Деталі замовлення (що конкретно робили і які запчастини ставили)
  parts    OrderPart[]
  services OrderService[]

  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")

  @@map("orders")
}

// 9. Проміжна таблиця: Запчастини в замовленні
model OrderPart {
  id String @id @default(cuid())

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  partId String @map("part_id")
  part   Part   @relation(fields: [partId], references: [id])

  quantity Int @default(1) // Скільки штук використали

  // Важливо: зберігаємо ціну на момент замовлення (історія цін)
  price Decimal @db.Decimal(10, 2)

  @@map("order_parts")
}

// 10. Проміжна таблиця: Послуги (роботи) в замовленні
model OrderService {
  id String @id @default(cuid())

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  serviceId String  @map("service_id")
  service   Service @relation(fields: [serviceId], references: [id])

  quantity Float @default(1) // Кількість нормо-годин або кількість операцій

  // Важливо: ціна на момент виконання
  price Decimal @db.Decimal(10, 2)

  @@map("order_services")
}

// 11. Для AI RAG (Технічна документація)
model Document {
  id       String @id @default(cuid())
  filename String // Назва файлу (Manual_Golf_5.pdf)
  content  String @db.Text // Текст, витягнутий з PDF

  // Вектори зберігаються окремо або через розширення pgvector. 
  // Для диплома часто достатньо зберігати текст і шукати по ньому, 
  // або використовувати Pinecone, тоді тут зберігаємо тільки метадані.
  externalId String? @map("external_id") // ID вектора в Pinecone

  createdAt DateTime @default(now()) @map("created_at")

  @@map("documents")
}
